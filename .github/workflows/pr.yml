name: PR Checks

on:
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build
        run: ./run build

      - name: Verify output
        run: |
          test -f dist/flash-live-system
          grep -q "BUSYBOX_EOF" dist/flash-live-system

  shellcheck:
    name: Shellcheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Shellcheck source script
        run: shellcheck flash-live-system

      - name: Shellcheck run script
        run: shellcheck run

  version-bump-check:
    name: Version bump check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check VERSION bumped since last stable release
        run: |
          BASE_SHA=$(git merge-base origin/main HEAD)
          CHANGED_FILES=$(git diff --name-only "$BASE_SHA"...HEAD)

          CURRENT_VERSION=$(cat VERSION | tr -d '[:space:]')

          # Find latest stable tag (v{upstream}+{revision}, no _pre suffix)
          LATEST_STABLE_TAG=$(git tag -l 'v*' \
            | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?\+[0-9]+$' \
            | sort -V | tail -1 || true)

          if [ -n "$LATEST_STABLE_TAG" ]; then
            TAGGED_VERSION=$(echo "$LATEST_STABLE_TAG" | sed 's/^v\(.*\)+[0-9]*$/\1/')

            if [ "$CURRENT_VERSION" != "$TAGGED_VERSION" ]; then
              echo "VERSION ($CURRENT_VERSION) differs from latest stable release ($TAGGED_VERSION) — no bump needed"
            else
              # VERSION matches latest stable tag — check if package-affecting files changed
              PACKAGE_FILES=$(echo "$CHANGED_FILES" \
                | grep -v -E '^(VERSION$|.*\.md$|docs/|\.github/|\.devcontainer/|\.vscode/|\.claude/)' \
                | grep -v -E '^(lefthook\.yml$|\.bumpversion\.cfg$|\.gitignore$|\.editorconfig$|LICENSE)' \
                | grep -v -E '^(tests?/|__tests__/|e2e/|.*\.test\.[^/]+$|.*\.spec\.[^/]+$)' \
                | grep -v -E '^(docker/|Dockerfile|docker-compose|config\.)' \
                | grep -v -E '^(tools/|run$|Makefile$|Taskfile\.yml$)' \
                | grep -v -E '\.(lock)$' \
                | grep -v -E '\.lintian-overrides$' \
                || true)

              if [ -n "$PACKAGE_FILES" ]; then
                echo "::error::Package-affecting files changed but VERSION ($CURRENT_VERSION) still matches the latest stable release ($LATEST_STABLE_TAG)."
                echo ""
                echo "Changed package files:"
                echo "$PACKAGE_FILES" | sed 's/^/  /'
                echo ""
                echo "VERSION needs to be bumped before the next release."
                exit 1
              fi
            fi
          else
            echo "No stable release tags found — skipping version check"
          fi
