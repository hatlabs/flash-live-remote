#!/usr/bin/env bash
set -euo pipefail

_require() {
  for cmd in "$@"; do
    if ! command -v "$cmd" &>/dev/null; then
      echo "Error: required command '$cmd' not found" >&2
      return 1
    fi
  done
}

if [ $# -lt 2 ]; then
  echo "Usage: flash-live-remote <host> <image>" >&2
  echo "" >&2
  echo "Flash an image to a remote Linux device over the network." >&2
  echo "The device must be running and accessible via SSH." >&2
  echo "" >&2
  echo "Supported formats: .img, .img.xz, .img.gz" >&2
  echo "" >&2
  echo "Examples:" >&2
  echo "  flash-live-remote halos.local image.img.xz" >&2
  echo "  flash-live-remote pi@192.168.1.100 image.img" >&2
  echo "" >&2
  echo "Prerequisites:" >&2
  echo "  Local:  ncat (from nmap), ssh" >&2
  echo "  Target: busybox (with nc applet), SSH access" >&2
  exit 1
fi

host="$1"
image="$2"
data_port=9999
signal_port=9998

# Validate image file exists
if [ ! -f "$image" ]; then
  echo "Error: image file not found: $image" >&2
  exit 1
fi

# Determine decompression command
decompress_cmd=""
case "$image" in
  *.img.xz) decompress_cmd="xzcat" ;;
  *.img.gz) decompress_cmd="zcat" ;;
  *.img)    decompress_cmd="cat" ;;
  *)
    echo "Error: unsupported image format (expected .img, .img.xz, or .img.gz)" >&2
    exit 1
    ;;
esac

_require ssh ncat "$decompress_cmd"

echo "=== Phase 0: Resolving hostname and checking target ==="

# Verify busybox is available on target
if ! ssh -n "$host" "command -v busybox" >/dev/null 2>&1; then
  echo "Error: busybox not found on $host (required for flash helper)" >&2
  exit 1
fi

target_ip=$(ssh -n "$host" "hostname -I | awk '{print \$1}'")
if [ -z "$target_ip" ]; then
  echo "Error: could not resolve IP for $host" >&2
  exit 1
fi
echo "Resolved $host -> $target_ip"

echo ""
echo "=== Phase 1: Preparing target ==="

# Detect root block device using lsblk PKNAME (parent kernel name)
root_part=$(ssh -n "$host" "findmnt -no SOURCE /")
if [ -z "$root_part" ]; then
  echo "Error: could not detect root partition" >&2
  exit 1
fi

root_dev=$(ssh -n "$host" "lsblk -ndo PKNAME '$root_part'")
if [ -z "$root_dev" ]; then
  echo "Error: could not determine parent device for $root_part" >&2
  exit 1
fi
root_dev="/dev/$root_dev"

# Validate the device exists
if ! ssh -n "$host" "test -b '$root_dev'"; then
  echo "Error: $root_dev is not a valid block device on $host" >&2
  exit 1
fi

dev_size=$(ssh -n "$host" "lsblk -bno SIZE '$root_dev' | head -1")
dev_size_gb=$((dev_size / 1073741824))

image_size=$(stat -f%z "$image" 2>/dev/null || stat -c%s "$image" 2>/dev/null || true)
if [ -z "$image_size" ]; then
  echo "Error: could not determine image file size" >&2
  exit 1
fi
image_size_mb=$((image_size / 1048576))

size_label="on-disk"
if [[ "$image" == *.img.xz ]] || [[ "$image" == *.img.gz ]]; then
  size_label="compressed"
fi

echo ""
echo "  Target device: $root_dev (~${dev_size_gb} GB)"
echo "  Root partition: $root_part"
echo "  Image file: $image (${image_size_mb} MB ${size_label})"
echo "  Target host: $host ($target_ip)"
echo ""
echo "WARNING: This will ERASE ALL DATA on $root_dev on $host."
echo "The device will be unreachable during flashing and will reboot when done."
echo ""
read -r -p "Type 'yes' to proceed: " confirm
if [ "$confirm" != "yes" ]; then
  echo "Aborted."
  exit 1
fi

echo ""
echo "Copying flash helper to target..."

# Helper script flow:
#   1. Stop services
#   2. Handshake with client on signal port (safe to abort here)
#   3. Start busybox nc | dd listener on data port
#   4. dd writes to raw block device (bypasses mounted filesystem)
#   5. After transfer: sync, reboot -f
ssh "$host" "cat > /dev/shm/flash-helper.sh" <<'HELPER_EOF'
#!/bin/bash
set -eo pipefail

TARGET_DEV="$1"
DATA_PORT="$2"
SIGNAL_PORT="$3"

echo "flash-helper: starting (target=$TARGET_DEV, data=$DATA_PORT, signal=$SIGNAL_PORT)"

# Stop services
echo "flash-helper: stopping services..."
systemctl stop 'container-*' 'marine-*' 'halos-*' cockpit docker 2>/dev/null || true
sync

# --- Handshake: signal readiness and wait for client confirmation ---
# This happens BEFORE any destructive action so the device can recover if the client aborts.
echo "flash-helper: signaling ready on port $SIGNAL_PORT..."
REPLY=$(echo "READY" | busybox nc -l -p "$SIGNAL_PORT" -w 60)
if [ "$REPLY" != "GO" ]; then
  echo "flash-helper: client did not confirm (got '$REPLY'), aborting"
  echo "flash-helper: rebooting to restore services..."
  reboot
  exit 1
fi
echo "flash-helper: client confirmed, starting listener"

# --- Start nc|dd listener and wait for transfer ---
echo "flash-helper: starting nc|dd listener on port $DATA_PORT -> $TARGET_DEV"
busybox nc -l -p "$DATA_PORT" | dd of="$TARGET_DEV" bs=4M 2>/dev/shm/dd-status
echo "flash-helper: dd complete, status:"
cat /dev/shm/dd-status 2>/dev/null || true
sync

echo "flash-helper: rebooting..."
reboot -f
HELPER_EOF

ssh -n "$host" "chmod +x /dev/shm/flash-helper.sh"

echo "Launching flash helper on target..."
# Use setsid to fully detach from SSH session, preventing SIGHUP on disconnect
ssh -n "$host" "sudo setsid /dev/shm/flash-helper.sh '$root_dev' '$data_port' '$signal_port' </dev/null >/dev/shm/flash-helper.log 2>&1 &"

echo ""
echo "=== Phase 2: Streaming image ==="

# Handshake: wait for helper to signal readiness on signal port
echo "Waiting for target to be ready..."
retries=0
max_retries=30
while true; do
  reply=$(echo "GO" | ncat "$target_ip" "$signal_port" 2>/dev/null) || true
  if [ "$reply" = "READY" ]; then
    echo "Target is ready, confirmed handshake."
    break
  fi
  retries=$((retries + 1))
  if [ "$retries" -ge "$max_retries" ]; then
    echo "Error: target not ready after ${max_retries}s" >&2
    echo "The device should still be recoverable (no destructive action was taken)." >&2
    exit 1
  fi
  sleep 1
  printf "."
done

# The data port listener starts immediately after the handshake completes.
# Give it a moment to bind before connecting.
sleep 2

start_time=$(date +%s)

echo "Streaming image..."
if ! "$decompress_cmd" "$image" | ncat --send-only "$target_ip" "$data_port"; then
  echo "" >&2
  echo "Error: transfer failed." >&2
  echo "The device may have a partial image. It will attempt to sync and reboot." >&2
  echo "If it doesn't come back, manual re-flash is needed." >&2
  exit 1
fi

end_time=$(date +%s)
elapsed_s=$((end_time - start_time))

echo ""
echo "Image transfer complete (${elapsed_s}s)."
echo "The device is syncing and will reboot automatically."
echo ""
echo "Wait ~60s then try: ssh $host"
